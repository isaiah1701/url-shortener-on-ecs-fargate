name : build image and test terraform and docker  configuration 

on: [push]
 

jobs: 
 build: 
  runs-on: ubuntu-latest
  steps: 
  - name:  Set up docker Buildx 
    uses:  docker/setup-buildx-action@v3

  - name: Login to docker hub
    uses: docker/login-action@v2
    with: 
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
  - name:  Build docker image 
    run: |
      cd app 
      docker build -t urlshortener:latest .
      docker tag urlshortener:latest isaiah4748/urlshortener:latest 
      docker tag urlshortener:latest isaiah4748/urlshortener:${{ github.sha }} 
      
  - name: Scan image with Trivy
    uses: aquasecurity/trivy-action@v0.16.0
    with:
      image-ref: isaiah4748/urlshortener:latest
      format: 'sarif'
      output: 'trivy-report.sarif'

  - name: Upload Trivy scan results
    uses: github/codeql-action/upload-sarif@v2
    with:
     sarif_file: trivy-report.sarif

